<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Registro de casos de simulaci√≥n ACLS</title>
<script src="https://cdn.tailwindcss.com"></script>
<meta content="noindex, nofollow" name="robots"/>
<style>
    /* Estilos base para todos los botones - Aspecto m√°s profesional */
    .btn-acls {
        transition: all 0.2s ease-in-out;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    
    /* Efecto suave de elevaci√≥n al hover */
    .btn-acls:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* Efecto cuando se presiona el bot√≥n */
    .btn-acls:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* Botones de acciones principales */
    .accion {
        @apply bg-blue-100 text-blue-800 font-medium border border-blue-200 hover:bg-blue-200 active:bg-blue-300;
    }
    
    /* Botones de acciones con desplegable */
    .accion-principal-desplegable {
        @apply bg-cyan-100 text-cyan-800 font-medium border border-cyan-200 hover:bg-cyan-200 active:bg-cyan-300;
    }
    
    /* Botones de sub-acciones */
    .sub-accion {
        @apply bg-blue-50 text-blue-700 font-medium border border-blue-100 hover:bg-blue-100;
    }
    
    /* Botones de ritmo */
    .accion-ritmo {
        @apply bg-slate-50 text-slate-700 border border-slate-200 hover:bg-slate-100 font-medium;
    }
    
    /* Botones de ritmo cuando est√°n activos */
    .accion-ritmo.active {
        @apply bg-green-100 text-green-800 border-green-300;
    }
    
    /* Botones de inicio caso y PCR - Destacados */
    #btnInicioCaso {
        @apply bg-blue-800 hover:bg-blue-900 active:bg-blue-950 text-white font-bold shadow-md;
    }
    
    #btnInicioPCR {
        @apply bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold shadow-md;
    }
    
    /* Botones de finalizaci√≥n y guardar */
    #btnFinalizar {
        @apply bg-amber-500 hover:bg-amber-600 active:bg-amber-700 text-white font-bold shadow-md;
    }
    
    #btnGuardar {
        @apply bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white font-bold shadow-md;
    }
    
    #btnDescartar {
        @apply bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold shadow-md;
    }
    
    /* Botones de acciones adicionales */
    #btnMasAcciones {
        @apply bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-bold shadow-md;
    }
    
    /* Contenedor de dropdown con sombra suave */
    .dropdown-content {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-radius: 0.375rem;
        @apply bg-white border border-gray-200;
    }
    
    /* Animaci√≥n de feedback al pulsar botones */
    @keyframes pulse-feedback {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .feedback-active {
        animation: pulse-feedback 0.3s ease;
        @apply bg-green-300 text-green-800 border-green-400;
    }
    
    /* Mejorar el aspecto de los bordes de los cron√≥metros */
    #cronometroCaso, #cronometroPCR {
        @apply font-mono text-2xl;
    }
    
    /* Mejorar visibilidad de los textos en botones */
    button {
        text-shadow: 0 1px 1px rgba(255,255,255,0.2);
    }
    
    button.bg-blue-800, button.bg-red-600, button.bg-amber-500, 
    button.bg-emerald-600, button.bg-blue-500 {
        text-shadow: 0 1px 1px rgba(0,0,0,0.2);
    }
    
    /* Estilos para estados de hover en el hist√≥rico */
    #listaInformes > div:hover {
        @apply bg-blue-50;
        transition: background-color 0.2s ease;
    }
</style>
<style>
    /* Estilo opcional para mejorar la apariencia del desplegable */
    .dropdown-content {
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    }
</style>
</head>
<body class="bg-gray-100 p-4">
<div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-6">
<h1 class="text-2xl font-bold text-center mb-2" style="color: #be1520;">Registro de casos de simulaci√≥n ACLS</h1><p class="text-center text-sm text-gray-600 mb-4">APP creada por Elena Plaza Moreno - Urgencias y Emergencias¬Æ - <a class="text-blue-600 underline" href="https://www.urgenciasyemergen.com" target="_blank">www.urgenciasyemergen.com</a></p>
<div class="mb-4">
    <button id="btnInstrucciones" class="w-full bg-cyan-600 text-white font-bold p-3 rounded mb-2">
        Instrucciones de uso ‚ñº
    </button>
    <div id="panelInstrucciones" class="hidden border p-4 rounded mb-4 bg-cyan-50">
        <h3 class="font-bold text-lg mb-2">¬øQu√© es esto?</h3>
        <p class="mb-4">Registro de casos de simulaci√≥n ACLS se trata de una APP web para registrar las acciones que se realizan durante la simulaci√≥n del soporte vital cardiovascular avanzado y generar un informe con registro de horas para poder realizar un debriefing estructurado sin perder datos.</p>
        <h3 class="font-bold text-lg mb-2">¬øC√≥mo usar esta aplicaci√≥n?</h3>
        <ol class="list-decimal pl-5 space-y-2">
            <li>Completa los datos del <strong>formulario principal</strong>.</li>
            <li>Pulsa <strong>‚ñ∂Ô∏è Iniciar caso</strong> para el cron√≥metro total de duraci√≥n del caso.</li>
            <li>Pulsa <strong>ü§ç Inicio PCR</strong> para el cron√≥metro de parada.</li>
            <li>Selecciona el <strong>ritmo real</strong> y el <strong>ritmo que han identificado los alumnos</strong> y registra las <strong>acciones</strong> que vayan realizando en tiempo real.</li>
            <li>Usa <strong>Acciones adicionales</strong> para casos de taquicardia y bradicardia.</li>
            <li>A√±ade <strong>observaciones</strong> que creas convenientes.</li>
            <li>Pulsa <strong>Finalizar Caso</strong> para ver el informe.</li>
            <li><strong>Guarda</strong> o <strong>Descarta</strong> el informe.</li>
            <li>Podr√°s acceder al <strong>Hist√≥rico</strong> siempre que uses la APP en el mismo ordenador.</li>
            <li>Si quieres que el registro est√© disponible en otro ordenador, usa <strong>Exportar/Importar</strong>. Con esta funci√≥n tambi√©n puedes realizar copias de seguridad, dado que si borras el historial de tu navegador, se borrar√°n los registros.</li>
        </ol>
        <p class="mt-4">Si tienes dudas o sugerencias, escribe a Elena Plaza - <a href="mailto:admin@urgenciasyemergen.com" class="text-blue-600 underline">admin@urgenciasyemergen.com</a></p>
    </div>
</div>
<div id="formularioPrincipal">
<div class="mb-4">
<label class="block font-bold">Fecha:</label>
<input class="w-full border p-2 rounded" id="fecha" type="date"/>
<label class="block font-bold mt-2">Nombre de alumnos:</label>
<input class="w-full border p-2 rounded" id="alumnos" type="text"/>
<label class="block font-bold mt-2">Centro educativo:</label>
<input class="w-full border p-2 rounded" id="centro" type="text"/>
<label class="block font-bold mt-2">Curso:</label>
<input class="w-full border p-2 rounded" id="curso" type="text"/>
<label class="block font-bold mt-2">Grupo:</label>
<input class="w-full border p-2 rounded" id="grupo" type="text"/>
<label class="block font-bold mt-2">Briefing del caso:</label>
<textarea class="w-full border p-2 rounded" id="briefing"></textarea>
</div>
<div class="mb-4 flex space-x-2">
<button class="w-1/2 bg-black text-white font-bold p-3 rounded" id="btnInicioCaso">‚ñ∂Ô∏è Iniciar caso</button>
<button class="w-1/2 bg-red-600 text-white font-bold p-3 rounded" id="btnInicioPCR">ü§ç Inicio PCR</button>
</div>
<div class="mb-4 flex justify-between">
<div class="text-center p-4 border-4 border-black w-1/2 mx-1">
<p class="text-lg font-bold">Inicio caso</p>
<p class="text-2xl" id="cronometroCaso">00:00</p>
</div>
<div class="text-center p-4 border-4 border-black w-1/2 mx-1">
<p class="text-lg font-bold">Inicio PCR</p>
<p class="text-2xl" id="cronometroPCR">00:00</p>
</div>
</div>

<div id="seccionRitmos" class="mb-4 border p-2 rounded bg-blue-50">
    <div>
        <h3 class="font-bold text-lg mb-1 text-center">Ritmo real</h3>
        <div class="flex flex-wrap gap-1 mb-1">
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">TVsp</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">FV</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">TdP</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">Asistolia</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">AESP</button>
        </div>
        <div class="flex flex-wrap gap-1 mb-1">
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">TSVP</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">FA</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">Flutter</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">TVcp</button>
        </div>
        <div class="flex flex-wrap gap-1">
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">BAV1¬∫</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">BAV2¬∫ tipo I</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">BAV2¬∫ tipo II</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="real">BAV3¬∫</button>
        </div>
    </div>
    <div class="mt-3">
        <h3 class="font-bold text-lg mb-1 text-center">Ritmo identificado por el alumno</h3>
         <div class="flex flex-wrap gap-1 mb-1">
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">TVsp</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">FV</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">TdP</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">Asistolia</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">AESP</button>
        </div>
        <div class="flex flex-wrap gap-1 mb-1">
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">TSVP</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">FA</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">Flutter</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">TVcp</button>
        </div>
        <div class="flex flex-wrap gap-1">
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">BAV1¬∫</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">BAV2¬∫ tipo I</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">BAV2¬∫ tipo II</button>
            <button class="accion-ritmo flex-grow bg-white border border-gray-300 p-2 rounded" data-tipo-ritmo="identificado">BAV3¬∫</button>
        </div>
    </div>
</div>
<h3 class="font-bold text-lg mb-2 text-center">Acciones</h3>

<div class="grid grid-cols-2 gap-2 mb-4">

    <div>
        <button class="accion bg-gray-300 p-3 rounded w-full text-center">¬øResponde? ¬øRespira?</button>
    </div>

    <div>
        <button class="accion bg-gray-300 p-3 rounded w-full text-center">Inicio de compresiones</button>
    </div>

    <div class="relative">
        <button class="accion-principal-desplegable w-full bg-gray-300 p-3 rounded text-center" data-target="sub-desfibrilacion">
            <span>Desfibrilaci√≥n</span> <span class="arrow">‚ñº</span>
        </button>
        <div id="sub-desfibrilacion" class="dropdown-content hidden absolute z-10 mt-1 w-full bg-gray-100 border rounded p-2 flex flex-col gap-1">
            <button class="sub-accion bg-gray-200 hover:bg-gray-300 p-2 rounded text-sm" data-accion-principal="Desfibrilaci√≥n">120 J</button>
            <button class="sub-accion bg-gray-200 hover:bg-gray-300 p-2 rounded text-sm" data-accion-principal="Desfibrilaci√≥n">150 J</button>
            <button class="sub-accion bg-gray-200 hover:bg-gray-300 p-2 rounded text-sm" data-accion-principal="Desfibrilaci√≥n">170 J</button>
            <button class="sub-accion bg-gray-200 hover:bg-gray-300 p-2 rounded text-sm" data-accion-principal="Desfibrilaci√≥n">200 J</button>
            <button class="sub-accion bg-gray-200 hover:bg-gray-300 p-2 rounded text-sm" data-accion-principal="Desfibrilaci√≥n">360 J</button>
        </div>
    </div>

    <div>
        <button class="accion bg-gray-300 p-3 rounded w-full text-center">V√≠a IV/IO</button>
    </div>

    <div class="relative">
        <button class="accion-principal-desplegable w-full bg-gray-300 p-3 rounded text-center" data-target="sub-via-aerea">
            <span>V√≠a a√©rea</span> <span class="arrow">‚ñº</span>
        </button>
        <div id="sub-via-aerea" class="dropdown-content hidden absolute z-10 mt-1 w-full bg-gray-100 border rounded p-2 flex flex-col gap-1">
            <button class="sub-accion bg-gray-200 hover:bg-gray-300 p-2 rounded text-sm" data-accion-principal="V√≠a a√©rea">Bal√≥n resucitador</button>
            <button class="sub-accion bg-gray-200 hover:bg-gray-300 p-2 rounded text-sm" data-accion-principal="V√≠a a√©rea">Dispositivo supragl√≥tico</button>
            <button class="sub-accion bg-gray-200 hover:bg-gray-300 p-2 rounded text-sm" data-accion-principal="V√≠a a√©rea">Intubaci√≥n orotraqueal</button>
        </div>
    </div>

    <div>
        <button class="accion bg-gray-300 p-3 rounded w-full text-center">Adrenalina</button>
    </div>

    <div class="relative">
        <button class="accion-principal-desplegable w-full bg-gray-300 p-3 rounded text-center" data-target="sub-amiodarona">
            <span>Amiodarona</span> <span class="arrow">‚ñº</span>
        </button>
        <div id="sub-amiodarona" class="dropdown-content hidden absolute z-10 mt-1 w-full bg-gray-100 border rounded p-2 flex flex-col gap-1">
            <button class="sub-accion bg-gray-200 hover:bg-gray-300 p-2 rounded text-sm" data-accion-principal="Amiodarona">300 mg</button>
            <button class="sub-accion bg-gray-200 hover:bg-gray-300 p-2 rounded text-sm" data-accion-principal="Amiodarona">150 mg</button>
        </div>
    </div>

    <div>
        <button class="accion bg-gray-300 p-3 rounded w-full text-center">Sulfato de magnesio</button>
    </div>

    <div>
        <button class="accion bg-gray-300 p-3 rounded w-full text-center">B√∫squeda de H y T</button>
    </div>

    <div>
        <button class="accion bg-gray-300 p-3 rounded w-full text-center">Seguridad de la escena</button>
    </div>

    <div>
        <button class="accion bg-gray-300 p-3 rounded w-full text-center">Cambio de reanimador</button>
    </div>

    <div>
        <button class="accion bg-gray-300 p-3 rounded w-full text-center">Buena comunicaci√≥n</button>
    </div>

</div> <div class="mb-4">
    <button id="btnMasAcciones" class="w-full bg-blue-500 text-white font-bold p-3 rounded mb-2">
        Acciones adicionales ‚ñº
    </button>
    <div id="accionesDesplegables" class="hidden grid grid-cols-2 gap-2">
        <button class="accion bg-gray-300 p-3 rounded">Cardioversi√≥n</button>
        <button class="accion bg-gray-300 p-3 rounded">Marcapasos</button>
        <button class="accion bg-gray-300 p-3 rounded">Adenosina</button>
        <button class="accion bg-gray-300 p-3 rounded">Verapamilo</button>
        <button class="accion bg-gray-300 p-3 rounded">Diltiazem</button>
        <button class="accion bg-gray-300 p-3 rounded">Procainamida</button>
        <button class="accion bg-gray-300 p-3 rounded">Atropina</button>
        <button class="accion bg-gray-300 p-3 rounded">Isoprenalina</button>
    </div>
</div>
<textarea class="w-full border p-2 rounded" id="observaciones" placeholder="Observaciones..."></textarea>
<div class="mt-4 flex flex-wrap gap-2">
<button class="w-full bg-yellow-500 text-white font-bold p-3 rounded" id="btnFinalizar">Finalizar Caso</button>
</div>
</div>
<div class="hidden" id="vistaInforme">
<h2 class="text-xl font-bold mb-4">Informe del caso</h2>
<div class="border p-4 rounded mb-4" id="contenidoInforme">
</div>
<div class="flex space-x-2" id="botonesInforme">
<button class="w-1/2 bg-green-600 text-white font-bold p-3 rounded" id="btnGuardar">Guardar Informe</button>
<button class="w-1/2 bg-red-600 text-white font-bold p-3 rounded" id="btnDescartar">Descartar</button>
</div>
</div>
<div class="hidden mt-4" id="vistaHistorico">
<h2 class="text-xl font-bold mb-4">Hist√≥rico de informes</h2>
<div class="max-h-60 overflow-y-auto" id="listaInformes"></div>
<button class="w-full bg-blue-600 text-white font-bold p-3 rounded mt-4" id="btnNuevoCaso">Nuevo Caso</button>
</div>
<div class="mt-4 flex gap-2">
<button class="bg-blue-500 text-white font-bold p-3 rounded" id="btnExportar">Exportar JSON</button>
<input accept=".json" class="hidden" id="inputImportar" type="file"/>
<button class="bg-orange-500 text-white font-bold p-3 rounded" id="btnImportar">Importar JSON</button>
</div>
</div>

<script>
        // Variables globales
        let informes = JSON.parse(localStorage.getItem("informes")) || [];
        let acciones = [];
        let tiempoCaso = 0, tiempoPCR = 0, intervaloCaso, intervaloPCR;
        let informeActual = null;
        let horaPCR = null;

        // Elementos DOM
        const formularioPrincipal = document.getElementById("formularioPrincipal");
        const vistaInforme = document.getElementById("vistaInforme");
        const vistaHistorico = document.getElementById("vistaHistorico");
        const contenidoInforme = document.getElementById("contenidoInforme");
        const listaInformes = document.getElementById("listaInformes");
        const botonesInforme = document.getElementById("botonesInforme");

        // --- Funciones auxiliares ---
        function formatearTiempo(segundos) {
            const minutos = Math.floor(segundos / 60);
            const segs = segundos % 60;
            return `${String(minutos).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;
        }

        function aplicarFeedbackVisual(boton) {
             let colorBase = "bg-gray-300";
             let needsBorder = false;

             if (boton.classList.contains('accion-ritmo')) {
                 colorBase = "bg-white";
                 needsBorder = true;
             } else if (boton.classList.contains('sub-accion')) {
                 colorBase = "bg-gray-200";
             }

             boton.classList.remove("bg-gray-300", "bg-gray-200", "bg-white");
             boton.classList.add("bg-green-300");

             if (!needsBorder) {
                 boton.classList.remove("border", "border-gray-300");
             }

             setTimeout(() => {
                 boton.classList.remove("bg-green-300");
                 boton.classList.add(colorBase);

                 if (needsBorder) {
                     boton.classList.add("border", "border-gray-300");
                 } else {
                     boton.classList.remove("border", "border-gray-300");
                 }
             }, 300);
         }


        function cerrarTodosDesplegables(excepto = null) {
             document.querySelectorAll('.dropdown-content').forEach(desplegable => {
                 if (desplegable.id !== excepto) {
                     desplegable.classList.add('hidden');
                     const botonId = desplegable.id.replace('sub-', '');
                     const botonPrincipal = document.querySelector(`[data-target="sub-${botonId}"]`);
                     if (botonPrincipal) {
                        const arrow = botonPrincipal.querySelector('.arrow');
                         if(arrow) arrow.textContent = '‚ñº';
                     }
                 }
             });
         }

        // --- Event Listeners ---

        document.getElementById("btnInstrucciones").addEventListener("click", () => {
            const panelInstrucciones = document.getElementById("panelInstrucciones");
            panelInstrucciones.classList.toggle("hidden");
            const btnInstrucciones = document.getElementById("btnInstrucciones");
            btnInstrucciones.textContent = panelInstrucciones.classList.contains("hidden") ? "Instrucciones de uso ‚ñº" : "Ocultar instrucciones ‚ñ≤";
        });

        cargarHistorico();

        document.getElementById("btnInicioCaso").addEventListener("click", () => {
            clearInterval(intervaloCaso);
            tiempoCaso = 0;
            document.getElementById("cronometroCaso").textContent = formatearTiempo(tiempoCaso);
            intervaloCaso = setInterval(() => {
                document.getElementById("cronometroCaso").textContent = formatearTiempo(++tiempoCaso);
            }, 1000);
        });

        document.getElementById("btnInicioPCR").addEventListener("click", () => {
            clearInterval(intervaloPCR);
            tiempoPCR = 0;
            document.getElementById("cronometroPCR").textContent = formatearTiempo(tiempoPCR);
            intervaloPCR = setInterval(() => {
                document.getElementById("cronometroPCR").textContent = formatearTiempo(++tiempoPCR);
            }, 1000);
            horaPCR = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }); // Formato HH:MM:SS
            acciones.push(`${horaPCR} - Inicio de RCP`);
        });

        // Acciones simples
        document.querySelectorAll(".accion").forEach(btn => {
            btn.addEventListener("click", () => {
                if (!btn.classList.contains('accion-principal-desplegable')) {
                    let hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    acciones.push(`${hora} - ${btn.textContent}`);
                    aplicarFeedbackVisual(btn);
                }
            });
        });

        // Listener botones de ritmo
        document.querySelectorAll(".accion-ritmo").forEach(btn => {
             btn.addEventListener("click", () => {
                 let hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                 let ritmo = btn.textContent;
                 let tipoRitmoRaw = btn.dataset.tipoRitmo;
                 let tipoRitmoTexto = tipoRitmoRaw === 'real' ? 'Ritmo real' : 'Ritmo identificado por el alumno';
                 acciones.push(`${hora} - ${tipoRitmoTexto} - ${ritmo}`);
                 aplicarFeedbackVisual(btn);
             });
         });


        // --- L√≥gica para botones con desplegable ---
         document.querySelectorAll(".accion-principal-desplegable").forEach(btn => {
             btn.addEventListener("click", (e) => {
                 e.stopPropagation();
                 const targetId = btn.dataset.target;
                 const desplegable = document.getElementById(targetId);
                 const isHidden = desplegable.classList.contains('hidden');
                 const arrow = btn.querySelector('.arrow');
                 cerrarTodosDesplegables(isHidden ? targetId : null);
                 if (isHidden) {
                     desplegable.classList.remove('hidden');
                     if(arrow) arrow.textContent = '‚ñ≤';
                 } else {
                     desplegable.classList.add('hidden');
                     if(arrow) arrow.textContent = '‚ñº';
                 }
             });
         });

         // Listener sub-acciones
         document.querySelectorAll(".sub-accion").forEach(btn => {
             btn.addEventListener("click", (e) => {
                e.stopPropagation();
                 let hora = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                 let accionPrincipal = btn.dataset.accionPrincipal;
                 let subOpcion = btn.textContent;
                 acciones.push(`${hora} - ${accionPrincipal} - ${subOpcion}`);
                 aplicarFeedbackVisual(btn);
                 const desplegablePadre = btn.closest('.dropdown-content');
                 if (desplegablePadre) {
                     desplegablePadre.classList.add('hidden');
                     const botonId = desplegablePadre.id.replace('sub-', '');
                     const botonPrincipal = document.querySelector(`[data-target="sub-${botonId}"]`);
                     if (botonPrincipal) {
                         const arrow = botonPrincipal.querySelector('.arrow');
                         if(arrow) arrow.textContent = '‚ñº';
                     }
                 }
             });
         });


         document.addEventListener('click', (e) => {
             if (!e.target.closest('.accion-principal-desplegable') && !e.target.closest('.dropdown-content')) {
                 cerrarTodosDesplegables();
             }
         });
        // --- Fin L√≥gica para botones con desplegable ---


        document.getElementById("btnFinalizar").addEventListener("click", () => {
            clearInterval(intervaloCaso);
            clearInterval(intervaloPCR);
            cerrarTodosDesplegables();

            informeActual = {
                fecha: document.getElementById("fecha").value,
                alumnos: document.getElementById("alumnos").value,
                centro: document.getElementById("centro").value,
                curso: document.getElementById("curso").value,
                grupo: document.getElementById("grupo").value,
                briefing: document.getElementById("briefing").value,
                observaciones: document.getElementById("observaciones").value,
                acciones: [...acciones],
                tiempoCaso: tiempoCaso,
                tiempoPCR: tiempoPCR,
                horaPCR: horaPCR,
                timestamp: new Date().getTime()
            };

            mostrarInforme(informeActual);
            formularioPrincipal.classList.add("hidden");
            vistaInforme.classList.remove("hidden");

             botonesInforme.innerHTML = `
                 <button class="w-1/2 bg-green-600 text-white font-bold p-3 rounded" id="btnGuardar">Guardar Informe</button>
                 <button class="w-1/2 bg-red-600 text-white font-bold p-3 rounded" id="btnDescartar">Descartar</button>
             `;
             document.getElementById("btnGuardar")?.addEventListener("click", guardarInformeHandler);
             document.getElementById("btnDescartar")?.addEventListener("click", descartarInformeHandler);

        });

        // --- Handlers para botones Guardar/Descartar/Volver ---
        function guardarInformeHandler() {
             if (informeActual) {
                 informes.push(informeActual);
                 localStorage.setItem("informes", JSON.stringify(informes));
                 informeActual = null;
                 cargarHistorico();
                 vistaInforme.classList.add("hidden");
                 vistaHistorico.classList.remove("hidden");
             }
         }

         function descartarInformeHandler() {
             reiniciarFormulario();
             vistaInforme.classList.add("hidden");
             formularioPrincipal.classList.remove("hidden");
         }

         function volverAlHistoricoHandler() {
             vistaInforme.classList.add("hidden");
             vistaHistorico.classList.remove("hidden");
         }
        // --- Fin Handlers ---

        // Asignaci√≥n inicial (se reasignan al mostrar informe/hist√≥rico)
        document.getElementById("btnGuardar")?.addEventListener("click", guardarInformeHandler);
        document.getElementById("btnDescartar")?.addEventListener("click", descartarInformeHandler);


        document.getElementById("btnNuevoCaso").addEventListener("click", () => {
            reiniciarFormulario();
            vistaHistorico.classList.add("hidden");
            formularioPrincipal.classList.remove("hidden");
        });

        document.getElementById("btnExportar").addEventListener("click", () => {
            if (informes.length === 0) {
                alert("No hay informes para exportar"); return;
            }
            const dataStr = JSON.stringify(informes, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `informes_acls_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
        });

        document.getElementById("btnImportar").addEventListener("click", () => {
            document.getElementById("inputImportar").click();
        });

        document.getElementById("inputImportar").addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (Array.isArray(importedData) && importedData.every(item => typeof item === 'object' && item !== null)) {
                         if (confirm(`Se importar√°n ${importedData.length} informes. ¬øDeseas REEMPLAZAR los informes existentes? Pulsa 'Cancelar' para A√ëADIRLOS.`)) {
                             informes = importedData;
                         } else {
                             const existingTimestamps = new Set(informes.map(inf => inf.timestamp));
                             const newData = importedData.filter(inf => !existingTimestamps.has(inf.timestamp));
                             informes = [...informes, ...newData];
                         }
                        localStorage.setItem("informes", JSON.stringify(informes));
                        cargarHistorico();
                        vistaHistorico.classList.remove("hidden");
                        formularioPrincipal.classList.add("hidden");
                        vistaInforme.classList.add("hidden");
                        alert(`Se han procesado los informes.`);
                    } else {
                        alert("El archivo JSON no contiene un array de informes v√°lido.");
                    }
                } catch (error) {
                    alert("Error al importar el archivo: " + error.message);
                } finally {
                    e.target.value = null;
                }
            };
            reader.onerror = () => { alert("Error al leer el archivo."); e.target.value = null; };
            reader.readAsText(file);
        });

        // --- Funciones de gesti√≥n de vistas e informes ---

        function mostrarInforme(informe) {
             const parseTime = (timeStr) => {
                if (!timeStr) return 0;
                 try {
                    const parts = timeStr.split(':');
                    if (parts.length === 3) {
                        return parseInt(parts[0], 10) * 3600 + parseInt(parts[1], 10) * 60 + parseInt(parts[2], 10);
                    }
                    return 0; // Formato inv√°lido
                 } catch (e) {
                    return 0; // Error al parsear
                 }
            };
             const sortedAcciones = [...informe.acciones].sort((a, b) => {
                // Extraer hora de forma segura
                const timeStrA = typeof a === 'string' ? a.split(' - ')[0] : '';
                const timeStrB = typeof b === 'string' ? b.split(' - ')[0] : '';
                return parseTime(timeStrA) - parseTime(timeStrB);
            });


             let html = `
                 <div class="space-y-2">
                     <p><strong>Fecha:</strong> ${informe.fecha || "No especificada"}</p>
                     <p><strong>Alumnos:</strong> ${informe.alumnos || "No especificados"}</p>
                     <p><strong>Centro:</strong> ${informe.centro || "No especificado"}</p>
                     <p><strong>Curso:</strong> ${informe.curso || "No especificado"}</p>
                     <p><strong>Grupo:</strong> ${informe.grupo || "No especificado"}</p>
                     <p><strong>Briefing:</strong> ${informe.briefing ? informe.briefing.replace(/\n/g, '<br>') : "No especificado"}</p>
                     <p><strong>Tiempo total del caso:</strong> ${formatearTiempo(informe.tiempoCaso)}</p>
                     <p><strong>Tiempo total de PCR:</strong> ${formatearTiempo(informe.tiempoPCR)}</p>
                     ${informe.horaPCR ? `<p><strong>Hora de inicio de PCR:</strong> ${informe.horaPCR}</p>` : ''}
                     <p><strong>Observaciones:</strong> ${informe.observaciones ? informe.observaciones.replace(/\n/g, '<br>') : "Ninguna"}</p>
                     <p><strong>Acciones registradas (ordenadas):</strong></p>
                     <ul class="list-disc pl-5 max-h-60 overflow-y-auto border rounded p-2 bg-gray-50">
                         ${sortedAcciones.map(accion => `<li>${accion}</li>`).join("") || "<li>No hay acciones registradas</li>"}
                     </ul>
                 </div>
             `;
             contenidoInforme.innerHTML = html;
         }

         function cargarHistorico() {
             listaInformes.innerHTML = "";
             if (informes.length === 0) {
                 listaInformes.innerHTML = "<p class='text-center py-4'>No hay informes guardados</p>"; return;
             }
             const sortedInformes = [...informes].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));


             sortedInformes.forEach((informe) => {
                 const uniqueId = informe.timestamp || Math.random() + Date.now();

                 const fecha = informe.fecha || new Date(informe.timestamp || Date.now()).toLocaleDateString();
                 const alumnos = informe.alumnos || "Sin alumnos";
                 const elementoInforme = document.createElement("div");
                 elementoInforme.className = "border p-3 mb-2 rounded cursor-pointer hover:bg-gray-100";
                 elementoInforme.dataset.id = uniqueId;
                 elementoInforme.innerHTML = `
                     <div class="flex justify-between items-center">
                         <div>
                             <p class="font-bold">${fecha} - ${alumnos}</p>
                             <p class="text-sm">${informe.centro || "Sin centro"} - ${informe.curso || "Sin curso"}</p>
                         </div>
                         <button class="text-red-600 hover:text-red-800 p-1 elim-informe" title="Eliminar informe">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                                 <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                             </svg>
                         </button>
                     </div>
                 `;

                 elementoInforme.addEventListener("click", (e) => {
                     if (e.target.closest(".elim-informe")) return;
                     const clickedId = elementoInforme.dataset.id;
                     const informeSeleccionado = informes.find(inf => (inf.timestamp || Math.random() + Date.now()) == clickedId);

                     if (informeSeleccionado) {
                         mostrarInforme(informeSeleccionado);
                         vistaHistorico.classList.add("hidden");
                         vistaInforme.classList.remove("hidden");
                         informeActual = null;
                         botonesInforme.innerHTML = `
                             <button class="w-full bg-blue-600 text-white font-bold p-3 rounded" id="btnVolver">Volver al hist√≥rico</button>
                         `;
                         document.getElementById("btnVolver")?.addEventListener("click", volverAlHistoricoHandler);
                     } else {
                         console.error("No se encontr√≥ el informe con ID:", clickedId);
                         alert("Error al cargar el informe seleccionado.");
                     }
                 });

                 elementoInforme.querySelector(".elim-informe").addEventListener("click", (e) => {
                     e.stopPropagation();
                      const clickedId = elementoInforme.dataset.id;
                      const indexToDelete = informes.findIndex(inf => (inf.timestamp || Math.random() + Date.now()) == clickedId);

                     if (indexToDelete !== -1 && confirm(`¬øEst√°s seguro de que quieres eliminar el informe de '${alumnos}' del '${fecha}'?`)) {
                         informes.splice(indexToDelete, 1);
                         localStorage.setItem("informes", JSON.stringify(informes));
                         cargarHistorico();
                     } else if (indexToDelete === -1) {
                         alert("No se pudo encontrar el informe para eliminar.");
                         cargarHistorico();
                     }
                 });

                 listaInformes.appendChild(elementoInforme);
             });
         }

         function reiniciarFormulario() {
             document.getElementById("fecha").valueAsDate = new Date();
             document.getElementById("alumnos").value = "";
             document.getElementById("centro").value = "";
             document.getElementById("curso").value = "";
             document.getElementById("grupo").value = "";
             document.getElementById("briefing").value = "";
             document.getElementById("observaciones").value = "";
             clearInterval(intervaloCaso);
             clearInterval(intervaloPCR);
             tiempoCaso = 0; tiempoPCR = 0;
             document.getElementById("cronometroCaso").textContent = "00:00";
             document.getElementById("cronometroPCR").textContent = "00:00";
             acciones = []; horaPCR = null; informeActual = null;
             cerrarTodosDesplegables();
             document.getElementById("panelInstrucciones").classList.add("hidden");
             document.getElementById("btnInstrucciones").textContent = "Instrucciones de uso ‚ñº";
             document.getElementById("accionesDesplegables").classList.add("hidden");
             document.getElementById("btnMasAcciones").textContent = "Acciones adicionales ‚ñº";

             // Resetear colores de todos los botones relevantes
             document.querySelectorAll(".accion, .accion-ritmo, .sub-accion, .accion-principal-desplegable").forEach(btn => {
                 btn.classList.remove("bg-green-300");

                 if (btn.classList.contains('sub-accion')) {
                     btn.classList.add("bg-gray-200");
                     btn.classList.remove("border", "border-gray-300");
                 } else if (btn.classList.contains('accion-ritmo')) {
                     btn.classList.add("bg-white", "border", "border-gray-300");
                 } else {
                     btn.classList.add("bg-gray-300");
                     btn.classList.remove("border", "border-gray-300");
                 }
             });

             document.querySelectorAll('.accion-principal-desplegable .arrow').forEach(arrow => arrow.textContent = '‚ñº');
         }


         document.getElementById("btnMasAcciones").addEventListener("click", () => {
             const accionesDesplegables = document.getElementById("accionesDesplegables");
             accionesDesplegables.classList.toggle("hidden");
             const btnMasAcciones = document.getElementById("btnMasAcciones");
             btnMasAcciones.textContent = accionesDesplegables.classList.contains("hidden") ? "Acciones adicionales ‚ñº" : "Ocultar acciones ‚ñ≤";
         });

         document.getElementById('fecha').valueAsDate = new Date();

         // Establecer formato de hora por defecto para que coincida con el registro
         // (Esto no afecta la l√≥gica, s√≥lo asegura consistencia si se muestra la hora actual en alg√∫n sitio)
         // const now = new Date();
         // const currentTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

</script>
<script>
// Protecci√≥n b√°sica
document.addEventListener('contextmenu', e => e.preventDefault());
// document.addEventListener('selectstart', e => e.preventDefault());

// Verificar referrer
if (document.referrer && !document.referrer.includes("urgenciasyemergen.com") && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
    // console.log("Acceso potencialmente no autorizado. Referrer:", document.referrer);
    // document.body.innerHTML = "<div style='text-align:center; padding: 50px; font-family:sans-serif;'>Acceso no autorizado. Debes acceder desde <a href=\"https://www.urgenciasyemergen.com\">urgenciasyemergen.com</a>.</div>";
}
</script>
</body>
</html>
